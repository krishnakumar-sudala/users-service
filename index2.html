<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Users Service Admin UI</title>
  <!-- Bootstrap CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  >
  <style>
    body {
      background-color: #f5f7fb;
    }
    .app-container {
      margin-top: 30px;
    }
    .card {
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    pre {
      max-height: 300px;
      overflow: auto;
      background: #111827;
      color: #e5e7eb;
      padding: 12px;
      border-radius: 6px;
    }
    .admin-only {
      display: none; /* shown dynamically if role === 'admin' */
    }
  </style>
</head>
<body>
  <div class="container app-container">
    <div class="row">
      <!-- LEFT COLUMN: Auth + Current User -->
      <div class="col-md-4 mb-3">
        <div class="card mb-3">
          <div class="card-header">
            <strong>Authentication</strong>
          </div>
          <div class="card-body">
            <!-- Tabs for Signup / Login -->
            <ul class="nav nav-tabs mb-3" id="authTabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="signup-tab" data-bs-toggle="tab"
                        data-bs-target="#signup-pane" type="button" role="tab">
                  Signup
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="login-tab" data-bs-toggle="tab"
                        data-bs-target="#login-pane" type="button" role="tab">
                  Login
                </button>
              </li>
            </ul>

            <div class="tab-content">
              <!-- SIGNUP -->
              <div class="tab-pane fade show active" id="signup-pane" role="tabpanel">
                <form id="signupForm">
                  <div class="mb-2">
                    <label class="form-label">Email</label>
                    <input type="email" id="signupEmail" class="form-control" required>
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Password</label>
                    <input type="password" id="signupPassword" class="form-control" required>
                  </div>
                  <button type="submit" class="btn btn-primary w-100 mt-2">Sign Up</button>
                </form>
              </div>

              <!-- LOGIN -->
              <div class="tab-pane fade" id="login-pane" role="tabpanel">
                <form id="loginForm">
                  <div class="mb-2">
                    <label class="form-label">Email</label>
                    <input type="email" id="loginEmail" class="form-control" required>
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Password</label>
                    <input type="password" id="loginPassword" class="form-control" required>
                  </div>
                  <button type="submit" class="btn btn-success w-100 mt-2">Login</button>
                </form>
              </div>
            </div>
          </div>
        </div>

        <!-- CURRENT USER PANEL -->
        <div class="card">
          <div class="card-header">
            <strong>Current Session</strong>
          </div>
          <div class="card-body" id="currentUser">
            <p class="text-muted mb-0">Not logged in.</p>
          </div>
        </div>
      </div>

      <!-- RIGHT COLUMN: Admin Actions + Output -->
      <div class="col-md-8 mb-3">
        <div class="card mb-3">
          <div class="card-header d-flex justify-content-between align-items-center">
            <strong>Admin Console</strong>
            <span class="badge bg-secondary" id="roleBadge">role: n/a</span>
          </div>
          <div class="card-body">
            <!-- Tabs: Users | Update | Delete -->
            <ul class="nav nav-tabs mb-3" id="adminTabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="users-tab" data-bs-toggle="tab"
                        data-bs-target="#users-pane" type="button" role="tab">
                  Users
                </button>
              </li>
              <li class="nav-item admin-only" role="presentation">
                <button class="nav-link" id="update-tab" data-bs-toggle="tab"
                        data-bs-target="#update-pane" type="button" role="tab">
                  Update User
                </button>
              </li>
              <li class="nav-item admin-only" role="presentation">
                <button class="nav-link" id="delete-tab" data-bs-toggle="tab"
                        data-bs-target="#delete-pane" type="button" role="tab">
                  Delete User
                </button>
              </li>
            </ul>

            <div class="tab-content">
              <!-- USERS TAB -->
              <div class="tab-pane fade show active" id="users-pane" role="tabpanel">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <h6 class="mb-0">All Users</h6>
                  <button id="getUsersBtn" class="btn btn-outline-primary btn-sm">
                    Refresh
                  </button>
                </div>
                <div class="table-responsive">
                  <table class="table table-sm table-striped align-middle" id="usersTable">
                    <thead>
                      <tr>
                        <th>ID</th>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Full Name</th>
                      </tr>
                    </thead>
                    <tbody>
                      <!-- Filled dynamically -->
                    </tbody>
                  </table>
                </div>
              </div>

              <!-- UPDATE TAB (ADMIN ONLY) -->
              <div class="tab-pane fade" id="update-pane" role="tabpanel">
                <form id="updateForm">
                  <div class="mb-2">
                    <label class="form-label">User ID</label>
                    <input type="text" id="updateId" class="form-control" required>
                  </div>
                  <div class="mb-2">
                    <label class="form-label">New Email (optional)</label>
                    <input type="email" id="updateEmail" class="form-control">
                  </div>
                  <div class="mb-2">
                    <label class="form-label">New Password (optional)</label>
                    <input type="password" id="updatePassword" class="form-control">
                  </div>
                  <button type="button" id="updateBtn" class="btn btn-warning mt-2">
                    Update User
                  </button>
                </form>
              </div>

              <!-- DELETE TAB (ADMIN ONLY) -->
              <div class="tab-pane fade" id="delete-pane" role="tabpanel">
                <form id="deleteForm">
                  <div class="mb-2">
                    <label class="form-label">User ID</label>
                    <input type="text" id="deleteId" class="form-control" required>
                  </div>
                  <button type="submit" class="btn btn-danger mt-2">
                    Delete User
                  </button>
                </form>
              </div>
            </div>
          </div>
        </div>

        <!-- RAW OUTPUT -->
        <div class="card">
          <div class="card-header">
            <strong>Raw Response</strong>
          </div>
          <div class="card-body">
            <pre id="output">{ }</pre>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1080">
    <div id="toast" class="toast align-items-center text-bg-primary border-0" role="alert">
      <div class="d-flex">
        <div class="toast-body" id="toastBody">
          <!-- message -->
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto"
                data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const API = "https://users-service-dev.apps-crc.testing";
    const output = document.getElementById('output');
    const currentUserDiv = document.getElementById('currentUser');
    const roleBadge = document.getElementById('roleBadge');
    const toastEl = document.getElementById('toast');
    const toastBody = document.getElementById('toastBody');
    const toast = new bootstrap.Toast(toastEl);

    function showToast(message, type = "primary") {
      toastEl.className = "toast align-items-center text-bg-" + type + " border-0";
      toastBody.textContent = message;
      toast.show();
    }

    function setOutput(data) {
      output.textContent = JSON.stringify(data, null, 2);
    }

    function updateSessionUI(user, token) {
      if (!user || !token) {
        currentUserDiv.innerHTML = '<p class="text-muted mb-0">Not logged in.</p>';
        roleBadge.textContent = 'role: n/a';
        document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
        return;
      }

      currentUserDiv.innerHTML = `
        <p class="mb-1"><strong>Email:</strong> ${user.email}</p>
        <p class="mb-1"><strong>Role:</strong> ${user.role}</p>
        <p class="mb-0"><strong>ID:</strong> ${user.id}</p>
      `;
      roleBadge.textContent = 'role: ' + user.role;

      if (user.role === 'admin') {
        document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'block');
      } else {
        document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
      }
    }

    function loadSessionFromStorage() {
      const token = localStorage.getItem("token");
      const userJson = localStorage.getItem("user");
      if (token && userJson) {
        try {
          const user = JSON.parse(userJson);
          updateSessionUI(user, token);
        } catch {
          updateSessionUI(null, null);
        }
      } else {
        updateSessionUI(null, null);
      }
    }

    async function authFetch(url, options = {}) {
      const token = localStorage.getItem("token");
      const headers = options.headers || {};
      if (token) {
        headers["Authorization"] = `Bearer ${token}`;
      }
      return fetch(url, { ...options, headers });
    }

    // SIGNUP
    document.getElementById('signupForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = signupEmail.value.trim();
      const password = signupPassword.value.trim();

      try {
        const res = await fetch(`${API}/auth/signup`, {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({ email, password })
        });
        const data = await res.json();
        setOutput(data);
        if (res.ok) {
          showToast("Signup successful", "success");
        } else {
          showToast(data.message || "Signup failed", "danger");
        }
      } catch (err) {
        setOutput({ error: err.message });
        showToast("Network error during signup", "danger");
      }
    });

    // LOGIN
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = loginEmail.value.trim();
      const password = loginPassword.value.trim();

      try {
        const res = await fetch(`${API}/auth/login`, {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({ email, password })
        });

        const data = await res.json();
        setOutput(data);

        if (res.ok && (data.accessToken || data.token)) {
          const token = data.accessToken || data.token;
          localStorage.setItem("token", token);

          // assume backend returns user info or decode from your own structure
          const user = data.user || { id: data.id, email: data.email, role: data.role } || {};
          localStorage.setItem("user", JSON.stringify(user));

          updateSessionUI(user, token);
          showToast("Login successful", "success");
        } else {
          showToast(data.message || "Login failed", "danger");
        }
      } catch (err) {
        setOutput({ error: err.message });
        showToast("Network error during login", "danger");
      }
    });

    // GET USERS
    document.getElementById('getUsersBtn').addEventListener('click', async () => {
      try {
        const res = await authFetch(`${API}/users`);
        const data = await res.json();
        setOutput(data);

        const tbody = document.querySelector('#usersTable tbody');
        tbody.innerHTML = "";
        if (Array.isArray(data)) {
          data.forEach(u => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${u.id}</td>
              <td>${u.email}</td>
              <td>${u.role || ''}</td>
              <td>${u.full_name || ''}</td>
            `;
            tbody.appendChild(tr);
          });
        }
        if (res.ok) {
          showToast("Users loaded", "info");
        } else {
          showToast(data.message || "Failed to load users", "danger");
        }
      } catch (err) {
        setOutput({ error: err.message });
        showToast("Network error while fetching users", "danger");
      }
    });

    // UPDATE USER
    document.getElementById('updateBtn').addEventListener('click', async (e) => {
      e.preventDefault();

      const id = updateId.value.trim();
      const email = updateEmail.value.trim();
      const password = updatePassword.value.trim();

      const payload = {};
      if (email) payload.email = email;
      if (password) payload.password = password;

      if (!id) {
        showToast("User ID is required", "warning");
        return;
      }
      if (Object.keys(payload).length === 0) {
        showToast("Provide at least one field to update", "warning");
        return;
      }

      try {
        const res = await authFetch(`${API}/users/${id}`, {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        setOutput(data);

        if (res.ok) {
          showToast("User updated successfully", "success");
        } else {
          showToast(data.message || "Update failed", "danger");
        }
      } catch (err) {
        setOutput({ error: err.message });
        showToast("Network error during update", "danger");
      }
    });

    // DELETE USER
    document.getElementById('deleteForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = deleteId.value.trim();
      if (!id) {
        showToast("User ID is required", "warning");
        return;
      }

      try {
        const res = await authFetch(`${API}/users/${id}`, {
          method: "DELETE"
        });
        const data = await res.json();
        setOutput(data);

        if (res.ok) {
          showToast("User deleted successfully", "success");
        } else {
          showToast(data.message || "Delete failed", "danger");
        }
      } catch (err) {
        setOutput({ error: err.message });
        showToast("Network error during delete", "danger");
      }
    });

    // Init
    loadSessionFromStorage();
  </script>
</body>
</html>
