<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Users Service Test UI</title>
</head>
<body>
  <h2>Users Service UI</h2>

<!-- SIGNUP -->
<h3>Signup</h3>
<form id="signupForm">
  <input type="email" id="signupEmail" placeholder="Email" required>
  <input type="password" id="signupPassword" placeholder="Password" required>
  <button type="submit">Sign Up</button>
</form>

<!-- LOGIN -->
<h3>Login</h3>
<form id="loginForm">
  <input type="email" id="loginEmail" placeholder="Email" required>
  <input type="password" id="loginPassword" placeholder="Password" required>
  <button type="submit">Login</button>
</form>

<!-- GET USERS -->
<h3>View All Users</h3>
<button id="getUsersBtn">Get Users</button>

<!-- UPDATE USER -->
<h3>Update User</h3>
<form id="updateForm">
  <input type="text" id="updateId" placeholder="User ID" required>
  <input type="email" id="updateEmail" placeholder="New Email">
  <input type="password" id="updatePassword" placeholder="New Password">
  <button type="button" id="updateBtn">Update</button>
</form>

<!-- DELETE USER -->
<h3>Delete User</h3>
<form id="deleteForm">
  <input type="text" id="deleteId" placeholder="User ID" required>
  <button type="submit">Delete</button>
</form>

<pre id="output"></pre>


<script>
const API = "https://users-service-dev.apps-crc.testing";

// SIGNUP
document.getElementById('signupForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const email = signupEmail.value;
  const password = signupPassword.value;

  const res = await fetch(`${API}/auth/signup`, {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ email, password })
  });

  output.textContent = JSON.stringify(await res.json(), null, 2);
});

// LOGIN
document.getElementById('loginForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const email = loginEmail.value;
  const password = loginPassword.value;

  const res = await fetch(`${API}/auth/login`, {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ email, password })
  });

  const data = await res.json();
  output.textContent = JSON.stringify(data, null, 2);

  // Save JWT for authenticated requests
  localStorage.setItem("token", data.accessToken || data.token);    //modified from data.token to data.accessToken
});

// GET USERS

document.getElementById('getUsersBtn').addEventListener('click', async () => {
  const token = localStorage.getItem("token");

  const res = await fetch(`${API}/users`, {
    headers: { "Authorization": `Bearer ${token}` }
  });

  output.textContent = JSON.stringify(await res.json(), null, 2);
});

// UPDATE USER

/*document.getElementById('updateBtn').addEventListener('click', async (e) => {
  e.preventDefault();
  const id = updateId.value;
  const email = updateEmail.value;
  const password = updatePassword.value;

  const token = localStorage.getItem("token");

  const res = await fetch(`${API}/users/${id}`, {
    method: "PATCH",
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${token}`
    },
    body: JSON.stringify({ email, password })
  });

  output.textContent = JSON.stringify(await res.json(), null, 2);
});*/

document.getElementById('updateBtn').addEventListener('click', async (e) => {
  e.preventDefault();

  const id = updateId.value.trim();
  const email = updateEmail.value.trim();
  const password = updatePassword.value.trim();

  const token = localStorage.getItem("token");

  // Build payload dynamically
  const payload = {};
  if (email) payload.email = email;
  if (password) payload.password = password;

  // If nothing to update, show message
  if (Object.keys(payload).length === 0) {
    output.style.color = "red";
    output.textContent = "Please enter at least one field to update.";
    return;
  }

  const res = await fetch(`${API}/users/${id}`, {
    method: "PATCH",
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${token}`
    },
    body: JSON.stringify(payload)
  });

  const data = await res.json();

  if (res.ok) {
    output.style.color = "green";
    output.textContent = "User updated successfully:\n" + JSON.stringify(data, null, 2);
  } else {
    output.style.color = "red";
    output.textContent = "Update failed:\n" + JSON.stringify(data, null, 2);
  }
});

// DELETE USER

document.getElementById('deleteForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const id = deleteId.value;
  const token = localStorage.getItem("token");

  const res = await fetch(`${API}/users/${id}`, {
    method: "DELETE",
    headers: { "Authorization": `Bearer ${token}` }
  });

  output.textContent = JSON.stringify(await res.json(), null, 2);
});
</script>
</body>
</html>